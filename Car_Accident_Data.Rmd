---
title: "Car Accident Data"
author: "chrlwhtng"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading the data:
```{r}
library(readr) 
library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
library(ggplot2)

data <- read_csv('US_Accidents_Dec19.csv')

```


Cleaning the data:
```{r}
#Select columns that will be useful in our research
crashData <- data %>% select("ID", "Start_Time", "Start_Lat", "Start_Lng",
                        "Street", "Side", "City", "County", "State", "Zipcode", 
                        "Temperature(F)", "Wind_Chill(F)", "Humidity(%)", 
                        "Pressure(in)", "Visibility(mi)", "Wind_Speed(mph)", 
                        "Precipitation(in)", "Weather_Condition", "Sunrise_Sunset", 
                        "Severity", "Description")

#Drop NA Value Rows
crashData <- crashData %>% na.omit()

#Create "Date" Column from Start_Time Column
#also creates "Time" column
crashData <- crashData %>% separate(col=Start_Time, into=c("Date", "Time"), sep=" ")

#Format date into a date column
crashData$Date <- ymd(crashData$Date)
```

Main Question: 

(Charlie) How do traffic accident rates compare between different regions in the US, and what variables in the dataset have the greatest association with accident rates that may cause these differences?

```{r}
crashPerState <- crashData %>% count(State)

states <- map_data("state")

#Remove DC, which is not in the states datframe.
crashPerState <- crashPerState %>% filter(State != 'DC')

#A list of all state names, to help  convert from "alabama" to "AL" to match crashData format.
stateName <- state.name %>% tolower()
states$State <- state.abb[match(states$region, stateName)]

nomatch1 <- crashPerState %>% anti_join(states, by='State')
unique(nomatch1$State) #Nothing missing.

StateCrashData <- crashPerState %>% left_join(states, by='State')

pop <- read_csv('USACountyPop.csv')

#pop data for most recent year of record - 2018.
pop <- pop %>% filter(Year == 2018)

#Convert pop data from "Alabama" to "AL"
pop$State <- tolower(pop$State)
pop$State <- state.abb[match(pop$State, stateName)]
pop <- pop %>% na.omit()

#Add up county population to get state population
pop <- pop %>% group_by(State) %>% mutate(StatePop = sum(Population))

StateCrashData <- StateCrashData %>% left_join(pop, by='State')

StateCrashData %>% ggplot(aes(x=long, y=lat)) + 
  geom_polygon(aes(group=group, fill= n / StatePop * 1000)) + 
  scale_fill_gradient(low='black', high='red')

```

```{r}
crashPerCounty <- crashData %>% group_by(State) %>% count(County)

county <- map_data("county")

crashPerCounty$County <- tolower(crashPerCounty$County)
county$County <- county$subregion

crashPerCounty$County <- gsub("\\.", "", crashPerCounty$County)

#Lots missing, not sure how to fix this
nomatch2 <- crashPerCounty %>% anti_join(county, by='County')
nomatch2

CountyCrashData <- crashPerCounty %>% left_join(county, by='County')

pop$County <- str_remove(pop$`County name`, " County")
pop$County <- tolower(pop$County)

#The same ones appear to be missing, if that means anything
nomatch3 <- CountyCrashData %>% anti_join(pop, by='County')
nomatch3

CountyCrashData <- CountyCrashData %>% left_join(pop, by='County')

CountyCrashData %>% ggplot(aes(x=long, y=lat)) + 
  geom_polygon(aes(group=group, fill= n / Population * 1000)) + 
  scale_fill_gradient(low='black', high='red')

#Not done, but from this, I'm not sure it's worth doing.... not much red at all
```

Just make a choropleth map of accident rates for both states and counties in the US

Sub Questions:

(Cole) 1. Does the population of states and counties affect accident rates, and in the counties with the highest populations does rush hour traffic times affect accident rates?
 
(Possible dataset to merge with our dataset for population of US counties and States https://www.kaggle.com/joshuapaulbarnard/population-of-usa-by-counties)
(Years on this dataset do not include 2019 so may need to find a new dataset for merging, also make sure to cite the dataset you end up using)


(Jake) 2. Are traffic accidents more common in the day or night and in turn does a higher or lower latitude have any correlation to the amount of traffic accidents that occur?

(Just Completely based on latitude for reasoning to see if a higher amount of daylight hours affects the amount of accidents)
(This question is not to figure out if harsher weather conditions have an affect on traffic accidents)


(Jake) 3. How do warmer states compare with colder states in traffic accident rates during the summer? Do these rates change when conditioning the data only on winter months? Is this change in rates large enough to justify that harsh winter weather conditions have a high correlation to traffic accident rates?

First figure out the average temperature for each state and then group them into high and low temperature states by splitting them in half

(Cole) 4. Show the distribution of visibility in traffic accidents in the US. What does the distribution tell us about the effects that different visibility levels have on how many traffic accidents occur?


(Charlie) 5. What are the most common weather conditions that occur during accidents? What states do these weather conditions occur at the highest rate in and are these states generally near the top of traffic accident rates when including all weather conditions?

```{r}
crashData %>% group_by(Weather_Condition) %>% filter(n() > 1000) %>%
  ggplot(aes(x=Weather_Condition)) + geom_bar(fill='black') + 
  geom_text(stat='count', aes(label=stat(count), vjust = -.5), size=2) + 
  theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, size=4)) + 
  scale_y_continuous(labels=scales::comma) + xlab("Weather Condition") + 
  ylab("Count of Crashes") + ggtitle("Count of Crashes by Weather Condition")
```

```{r}
commonWeather <- crashData %>% filter(Weather_Condition == 'Cloudy' |
        Weather_Condition ==  'Fair' | Weather_Condition == 'Light Rain' | 
        Weather_Condition == 'Light Snow' | Weather_Condition == 'Mostly Cloudy' |
        Weather_Condition == 'Partly Cloudy')

commonWeather %>% group_by(State) %>% ggplot(aes(x=State)) + geom_bar(fill='black') + 
  theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, size=4)) + 
  ylab("Count of Crashes") + ggtitle("Count of Crashes in Common Weather Conditions by State")
```

(Shows how great of an affect these weather conditions can have on traffic accident rates answering most of the main question)

(Juan) 6. What is the relationship between the amount of precipitation on the ground and the amount of accidents that happen? How does this relationship vary when conditioned on different types of precipitation(Snow, Sleet, Rain)?


(Juan) 7. Between the first year and last year how have accident rates changed over all counties in the US? What counties accident rate has increased the most and which has decreased the most? What may be the reason for this?

For the reasoning lookup possible events that occured in the news in those counties in between the time start and end time that may have influenced such a drastic change











